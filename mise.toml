[tools]
node = "lts"

[tasks.install]
run = "npm install"
description = "Install dependencies"

[tasks.start]
run = "npx serve ."
description = "Start the project"

# Testing Tasks
[tasks.test]
run = '''
#!/bin/bash
TIMESTAMP=${QA_TIMESTAMP:-$(date +%Y-%m-%d_%H-%M-%S)}
RESULTS_DIR="test-results/$TIMESTAMP"
mkdir -p "$RESULTS_DIR/unit" "$RESULTS_DIR/e2e"

echo "ðŸ“‚ Test Results Directory: $RESULTS_DIR"

# Run Unit Tests (Vitest)
echo "â–¶ï¸  Running Unit Tests..."
npm run test:unit -- \
  --reporter=default \
  --reporter=json --outputFile.json="$RESULTS_DIR/unit/results.json" \
  --reporter=html --outputFile.html="$RESULTS_DIR/unit/index.html"

UNIT_EXIT_CODE=$?

# Run E2E Tests (Playwright)
echo "â–¶ï¸  Running E2E Tests..."
PLAYWRIGHT_HTML_REPORT="$RESULTS_DIR/e2e/report" npm run test:e2e -- \
  --output="$RESULTS_DIR/e2e/artifacts" \
  --reporter=list \
  --reporter=html

E2E_EXIT_CODE=$?

# Summarize
echo "----------------------------------------"
echo "âœ… Results stored in: $RESULTS_DIR"
echo "ðŸ“„ Unit Report: $RESULTS_DIR/unit/index.html"
echo "ðŸ“„ E2E Report:  $RESULTS_DIR/e2e/report/index.html"
echo "----------------------------------------"

# Exit with failure if either failed
if [ $UNIT_EXIT_CODE -ne 0 ] || [ $E2E_EXIT_CODE -ne 0 ]; then
  exit 1
fi
'''
description = "Run all tests with hierarchical timestamped reporting"

[tasks.test-unit]
run = "npm run test:unit"
description = "Run unit tests (Vitest - fast)"

[tasks.test-unit-watch]
run = "npm run test:unit:watch"
description = "Run unit tests in watch mode"

[tasks.test-unit-coverage]
run = "npm run test:unit:coverage"
description = "Run unit tests with coverage report"

[tasks.test-e2e]
run = "npm run test:e2e"
description = "Run E2E tests (Playwright)"

[tasks.test-e2e-ui]
run = "npm run test:e2e:ui"
description = "Run E2E tests with UI"

[tasks.test-e2e-debug]
run = "npm run test:e2e:debug"
description = "Run E2E tests in debug mode"

[tasks.test-e2e-remote]
run = "BASE_URL=${1:-https://pradyumnac.github.io/newslauncher/} npm run test:e2e"
description = "Run E2E tests against remote URL (default: production)"

# Static Analysis Tasks
[tasks.lint]
run = '''
#!/bin/bash
TIMESTAMP=${QA_TIMESTAMP:-$(date +%Y-%m-%d_%H-%M-%S)}
RESULTS_DIR="test-results/$TIMESTAMP/lint"
mkdir -p "$RESULTS_DIR"
echo "â–¶ï¸  Running Lint..."
ESLINT_USE_FLAT_CONFIG=false npx eslint . | tee "$RESULTS_DIR/output.log"
exit ${PIPESTATUS[0]}
'''
description = "Lint JavaScript files"

[tasks.format]
run = "npx prettier --write ."
description = "Format all files"

[tasks.check-format]
run = '''
#!/bin/bash
TIMESTAMP=${QA_TIMESTAMP:-$(date +%Y-%m-%d_%H-%M-%S)}
RESULTS_DIR="test-results/$TIMESTAMP/check-format"
mkdir -p "$RESULTS_DIR"
echo "â–¶ï¸  Checking Format..."
npx prettier --check . | tee "$RESULTS_DIR/output.log"
exit ${PIPESTATUS[0]}
'''
description = "Check file formatting"

[tasks.check-spelling]
run = '''
#!/bin/bash
TIMESTAMP=${QA_TIMESTAMP:-$(date +%Y-%m-%d_%H-%M-%S)}
RESULTS_DIR="test-results/$TIMESTAMP/check-spelling"
mkdir -p "$RESULTS_DIR"
echo "â–¶ï¸  Checking Spelling..."
npx cspell '**' | tee "$RESULTS_DIR/output.log"
exit ${PIPESTATUS[0]}
'''
description = "Check spelling across the project"

[tasks.validate-html]
run = '''
#!/bin/bash
TIMESTAMP=${QA_TIMESTAMP:-$(date +%Y-%m-%d_%H-%M-%S)}
RESULTS_DIR="test-results/$TIMESTAMP/validate-html"
mkdir -p "$RESULTS_DIR"
echo "â–¶ï¸  Validating HTML..."
npx html-validate '*.html' | tee "$RESULTS_DIR/output.log"
exit ${PIPESTATUS[0]}
'''
description = "Validate HTML files"

[tasks.check]
run = '''
#!/bin/bash
export QA_TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
echo "ðŸš€ Starting Full Check (Timestamp: $QA_TIMESTAMP)"
echo "ðŸ“‚ Results will be stored in test-results/$QA_TIMESTAMP"

mise run lint
mise run check-format
mise run check-spelling
mise run validate-html
'''
description = "Run all static analysis checks with logging"

# Performance & CI Tasks
[tasks.lighthouse]
run = '''
#!/bin/bash
TIMESTAMP=${QA_TIMESTAMP:-$(date +%Y-%m-%d_%H-%M-%S)}
RESULTS_DIR="test-results/$TIMESTAMP/lighthouse"
mkdir -p "$RESULTS_DIR"
echo "â–¶ï¸  Running Lighthouse..."
npx lhci autorun | tee "$RESULTS_DIR/output.log"
LH_EXIT=${PIPESTATUS[0]}

# Copy artifacts if they exist
if [ -d ".lighthouseci" ]; then
  cp -r .lighthouseci/* "$RESULTS_DIR/" 2>/dev/null || true
fi

exit $LH_EXIT
'''
description = "Run Lighthouse performance audit"

[tasks.ci]
run = '''
#!/bin/bash
export QA_TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
echo "ðŸš€ CI Pipeline Started (Timestamp: $QA_TIMESTAMP)"
echo "ðŸ“‚ All artifacts will be stored in test-results/$QA_TIMESTAMP"

mise run install
mise run check
mise run test
mise run lighthouse
'''
description = "CI Pipeline"

[tasks.pre-commit]
run = "npx lint-staged"
description = "Pre-commit hook"

[tasks.deploy]
depends = ["ci"]
run = "git push"
description = "Deploy to GitHub Pages (Run CI then push)"
