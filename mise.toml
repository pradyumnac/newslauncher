[tools]
node = "lts"

[tasks.install]
run = "npm install"
description = "Install dependencies"

[tasks.start]
run = "npx serve ."
description = "Start the project"

# Testing Tasks
[tasks.test]
run = '''
#!/bin/bash
TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
RESULTS_DIR="test-results/$TIMESTAMP"
mkdir -p "$RESULTS_DIR/unit" "$RESULTS_DIR/e2e"

echo "üìÇ Test Results Directory: $RESULTS_DIR"

# Run Unit Tests (Vitest)
echo "‚ñ∂Ô∏è  Running Unit Tests..."
npm run test:unit -- \
  --reporter=default \
  --reporter=json --outputFile.json="$RESULTS_DIR/unit/results.json" \
  --reporter=html --outputFile.html="$RESULTS_DIR/unit/index.html"

UNIT_EXIT_CODE=$?

# Run E2E Tests (Playwright)
echo "‚ñ∂Ô∏è  Running E2E Tests..."
PLAYWRIGHT_HTML_REPORT="$RESULTS_DIR/e2e/report" npm run test:e2e -- \
  --output="$RESULTS_DIR/e2e/artifacts" \
  --reporter=list \
  --reporter=html

E2E_EXIT_CODE=$?

# Summarize
echo "----------------------------------------"
echo "‚úÖ Results stored in: $RESULTS_DIR"
echo "üìÑ Unit Report: $RESULTS_DIR/unit/index.html"
echo "üìÑ E2E Report:  $RESULTS_DIR/e2e/report/index.html"
echo "----------------------------------------"

# Exit with failure if either failed
if [ $UNIT_EXIT_CODE -ne 0 ] || [ $E2E_EXIT_CODE -ne 0 ]; then
  exit 1
fi
'''
description = "Run all tests with hierarchical timestamped reporting"

[tasks.test-unit]
run = "npm run test:unit"
description = "Run unit tests (Vitest - fast)"

[tasks.test-unit-watch]
run = "npm run test:unit:watch"
description = "Run unit tests in watch mode"

[tasks.test-unit-coverage]
run = "npm run test:unit:coverage"
description = "Run unit tests with coverage report"

[tasks.test-e2e]
run = "npm run test:e2e"
description = "Run E2E tests (Playwright)"

[tasks.test-e2e-ui]
run = "npm run test:e2e:ui"
description = "Run E2E tests with UI"

[tasks.test-e2e-debug]
run = "npm run test:e2e:debug"
description = "Run E2E tests in debug mode"

[tasks.test-e2e-remote]
run = "BASE_URL=${1:-https://pradyumnac.github.io/newslauncher/} npm run test:e2e"
description = "Run E2E tests against remote URL (default: production)"

# Static Analysis Tasks
[tasks.lint]
run = "ESLINT_USE_FLAT_CONFIG=false npx eslint ."
description = "Lint JavaScript files"

[tasks.format]
run = "npx prettier --write ."
description = "Format all files"

[tasks.check-format]
run = "npx prettier --check ."
description = "Check file formatting"

[tasks.check-spelling]
run = "npx cspell '**'"
description = "Check spelling across the project"

[tasks.validate-html]
run = "npx html-validate '*.html'"
description = "Validate HTML files"

[tasks.check]
depends = ["lint", "check-format", "check-spelling", "validate-html"]
description = "Run all static analysis checks"

# Performance & CI Tasks
[tasks.lighthouse]
run = "npx lhci autorun"
description = "Run Lighthouse performance audit"

[tasks.ci]
depends = ["install", "check", "test", "lighthouse"]
description = "CI Pipeline"

[tasks.pre-commit]
run = "npx lint-staged"
description = "Pre-commit hook"

[tasks.deploy]
depends = ["ci"]
run = "git push"
description = "Deploy to GitHub Pages (Run CI then push)"
